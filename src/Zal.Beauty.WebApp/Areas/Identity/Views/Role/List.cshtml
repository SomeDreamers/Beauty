@model List<RoleInfoResult>

@section Styles{
    <link rel="stylesheet" href="~/lib/xenon/assets/js/uikit/uikit.css">
    <style type="text/css">
        .uk-nestable-item {
            padding: 5px 8px;
        }
    </style>
}

@section Scripts{
    <script src="~/lib/xenon/assets/js/uikit/js/uikit.min.js"></script>
    <script src="~/lib/xenon/assets/js/uikit/js/addons/nestable.min.js"></script>
    <script type="text/javascript">
        $(function () {
            var id = 0;

            //编辑角色按钮点击事件
            $(".role-edit").click(function () {
                id = $(this).attr("data-id");
                $('#edit-role-modal').modal('show', { backdrop: 'static' });
                $.ajax({
                    url: "/Identity/Role/Edit",
                    data: { id: id },
                    success: function (response) {
                        $('#edit-role-modal .modal-body').html(response);
                    }
                });
            });

            //编辑角色保存
            $("#edit-role-modal .save-btn").click(function () {
                var role = {};
                role.Id = id;
                role.Name = $("#edit-role-modal #Name").val();
                role.Memo = $("#edit-role-modal #Memo").val();
                show_loading_bar(70);
                $.post("/Identity/Role/Save", { role: role }, function (resp) {
                    show_loading_bar({
                        pct: 100,
                        finish: function () {
                            if (resp.isSuccess) {
                                $('#edit-role-modal').modal("hide");
                                window.location.reload();
                            }
                            else {
                                toastr.error(resp.message, "操作错误!");
                            }
                        }
                    });
                });
            });

            //新增角色按钮点击事件
            $(".create-role-btn").click(function () {
                $("#create-role-modal #Name").val("");
                $("#create-role-modal #Memo").val("");
                $('#create-role-modal').modal('show', { backdrop: 'static' });
            });

            //新建角色保存
            $("#create-role-modal .save-btn").click(function () {
                var role = {};
                role.Name = $("#create-role-modal #Name").val();
                role.Memo = $("#create-role-modal #Memo").val();
                show_loading_bar(70);
                $.post("/Identity/Role/Save", { role: role }, function (resp) {
                    show_loading_bar({
                        pct: 100,
                        finish: function () {
                            if (resp.isSuccess) {
                                $('#edit-role-modal').modal("hide");
                                window.location.reload();
                            }
                            else {
                                toastr.error(resp.message, "操作错误!");
                            }
                        }
                    });
                });
            })

            //删除角色点击事件
            $(".role-del").click(function () {
                id = $(this).attr("data-id");
                $Zaolazi.confirmModal("确定删除角色？", function () {
                    show_loading_bar(70);
                    $.post("/Identity/Role/Delete", { id: id }, function (resp) {
                        show_loading_bar({
                            pct: 100,
                            finish: function () {
                                if (resp.isSuccess) {
                                    window.location.reload();
                                }
                                else {
                                    toastr.error(resp.message, "操作错误!");
                                }
                            }
                        });
                    });
                });
            });

            //新增角色按钮点击事件
            $(".create-role-btn").click(function () {
                $("#create-role-modal #Name").val("");
                $("#create-role-modal #Memo").val("");
                $('#create-role-modal').modal('show', { backdrop: 'static' });
            });

            //新建角色保存
            $("#create-role-modal .save-btn").click(function () {
                var role = {};
                role.Name = $("#create-role-modal #Name").val();
                role.Memo = $("#create-role-modal #Memo").val();
                show_loading_bar(70);
                $.post("/Identity/Role/Save", { role: role }, function (resp) {
                    show_loading_bar({
                        pct: 100,
                        finish: function () {
                            if (resp.isSuccess) {
                                $('#edit-role-modal').modal("hide");
                                window.location.reload();
                            }
                            else {
                                toastr.error(resp.message, "操作错误!");
                            }
                        }
                    });
                });
            })

            $('#table').bootstrapTable({
                //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
                cache: false,
                url: "/Identity/User/UserSetAjax",
                sidePagination: 'server',
                pagination: true,
                pageList: [2, 10, 20, 50, 100],
                showColumns: true,
                showRefresh: true,
                search: false,
                searchOnEnterKey: true,
                trimOnSearch: true,
                uniqueId: 'id',           // 绑定ID
                //showPaginationSwitch: true,
                toolbar: "#toolbar",                   //工具按钮用哪个容器
                //得到查询的参数
                queryParams: function (params) {
                    //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                    var temp = {
                        Size: params.limit,                         //页面大小
                        Start: params.offset,   //页码
                        Column: params.sort,      //排序列名
                        Sort: params.order //排位命令（desc，asc）
                    };
                    $(".search-control").each(function () {
                        var $this = $(this);
                        var name = $this.attr("name");
                        var value = $this.val();
                        if (value)
                            temp[name] = value;
                    })
                    return temp;
                },
                columns: [
                    { checkbox: true, visible: true },
                    { field: 'name', title: '用户名' },
                    { field: 'trueName', title: '真实姓名' },
                    { field: 'phone', title: '电话' },
                    { field: 'mail', title: '邮箱' },
                    { field: 'address', title: '地址' },
                    { field: 'createTime', title: '创建时间', sortable: true, formatter: dateFormmatter },
                    { field: 'type', title: '用户类型', formatter: typeFormmatter },
                    { field: 'status', title: '用户状态', formatter: statusFormmatter },
                    { field: 'id', title: '操作', formatter: actionFormmatter },
                ],
                responseHandler: function (result) {
                    var data = {};
                    data.total = result.total;
                    data.rows = result.entities;
                    return data;
                }
            });

            //表格用户状态转换
            function statusFormmatter(value, row, index) {
                if (value == 1)
                    return "启用";
                else
                    return "禁用";
            }

            //表格用户类型转换
            function typeFormmatter(value, row, index) {
                if (value == 1)
                    return "客户";
                else
                    return "管理员";
            }

            //表格操作列
            function actionFormmatter(value, row, index) {
                var id = value;
                var typeAdmin = row.type === 2;
                var statusDisabled = row.status === 2;
                var result = "";
                result += "<button class='btn btn-primary btn-sm btn-icon edit-user-btn' data='" + id + "'>编辑</button>";
                result += "<button class='btn btn-warning btn-sm btn-icon' onclick=\"UpdateUserType(" + id + ", " + (typeAdmin ? 1 : 2) + ")\">" + (typeAdmin ? "设为客户" : "设为管理员") + "</button>";
                result += "<button class='btn btn-danger btn-sm btn-icon' onclick=\"UpdateUserStatus(" + id + ", " + (statusDisabled ? 1 : 2) + ")\">" + (statusDisabled ? "启用" : "禁用") + "</button>";

                return result;
            }
        });
    </script>
}

@Html.BlockQuote()
<div class="panel panel-default">
    @*<div class="panel-heading">角色管理</div>*@
    <div class="btn-group">
        <button type="button" class="btn btn-success create-role-btn">
            <span class="glyphicon glyphicon-check" aria-hidden="true"></span>新增角色
        </button>
    </div>
    <div class="panel-body">

        <div class="row">
            <div class="col-sm-12">

                @foreach (var item in Model)
                {
                    <ul id="nestable-list-1" class="uk-nestable" data-uk-nestable>
                        <li data-item="@item.Name" data-item-id="@item.Id" class="uk-nestable-list-item uk-parent uk-collapsed">
                            <div class="uk-nestable-item">
                                <div data-nestable-action="toggle"></div>
                                <div class="list-label">@item.Name <span>(@item.Users.Count)</span></div>
                                <div style="float:right;">
                                    @if (item.Users.Count == 0)
                                    {
                                        <a href="javascript:void(0)" title="删除角色" class="role-del" data-id="@item.Id"><i class="linecons-trash"></i></a>
                                    }
                                    <a href="javascript:void(0)" title="添加用户" class="user-add" data-id="@item.Id"><i class="glyphicon glyphicon-plus-sign"></i></a>
                                    <a href="javascript:void(0)" title="编辑角色" class="role-edit" data-id="@item.Id"><i class="linecons-pencil"></i></a>

                                </div>
                            </div>

                            <ul id="role-user-@item.Id">
                                @foreach (var user in item.Users)
                                {
                                    <li data-item="@user.Name" data-item-id="@user.Id">
                                        <div class="uk-nestable-item">
                                            <div class="list-label">@user.Name</div>
                                            <div style="float:right;">
                                                <a href="javascript:void(0)" title="移除用户" class="user-remove" data-id="@item.Id" data-user-id="@user.Id"><i class="glyphicon glyphicon-remove-sign"></i></a>
                                            </div>
                                        </div>
                                    </li>
                                }
                            </ul>
                        </li>
                    </ul>
                }
            </div>
        </div>
    </div>
</div>

@* 编辑角色模态框 *@
<div class="modal fade" id="edit-role-modal" data-backdrop="static" aria-hidden="false" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">编辑角色</h4>
            </div>

            <div class="modal-body">

                加载中...

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary save-btn">保存</button>
            </div>
        </div>
    </div>
</div>

@* 新建角色模态框 *@
<div class="modal fade in" id="create-role-modal" data-backdrop="static" aria-hidden="false" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">新建角色</h4>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="control-label" for="Name">角色名</label>
                            <input class="form-control" id="Name" name="Name" type="text" value="">
                        </div>
                    </div>

                    <div class="col-md-12">
                        <div class="form-group">
                            <label class="control-label" for="Memo">备注</label>
                            <input class="form-control" id="Memo" name="Memo" type="text" value="">
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary save-btn">保存</button>
            </div>
        </div>
    </div>
</div>

@* 选择用户模态框 *@
<div class="modal fade" id="select-user-modal" data-backdrop="static" aria-hidden="false" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                <h4 class="modal-title">选择用户</h4>
            </div>

            <div class="modal-body">
                <div class="search-bar" style="padding-bottom: 10px;border-bottom: 1px solid #eeeeee;">
                    <input class="form-control search-control" type="text" name="Name" title="姓名" placeholder="姓名">
                    <input class="form-control search-control" type="text" name="TrueName" title="真实姓名" placeholder="真实姓名">
                    <input class="form-control search-control" type="text" name="Phone" title="电话" placeholder="电话">
                    <select class="form-control search-control" name="Type" title="用户类型" asp-items="@Html.GetEnumSelectList(typeof(EUserType))">
                        <option value="">用户类型</option>
                    </select>
                    <select class="form-control search-control" name="Status" title="用户状态" asp-items="@Html.GetEnumSelectList(typeof(EUserStatus))">
                        <option value="">用户状态</option>
                    </select>
                    <div class="btn-group" style="float:right;">
                        <button id="btn_edit" type="button" class="btn btn-default search-control-btn">
                            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>搜索
                        </button>
                        <button id="btn_add" type="button" class="btn btn-default clear-control-btn">
                            <span class="glyphicon glyphicon-remove-circle" aria-hidden="true"></span>清空
                        </button>
                    </div>
                </div>
                <table id="table"></table>
            </div>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-white" data-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary save-btn">确定</button>
        </div>
    </div>
</div>